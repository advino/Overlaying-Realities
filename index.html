<!DOCTYPE html>

<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=.5">

<head>
  <title>WebApp Demo</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://threejs.org/build/three.min.js" type="text/javascript"></script>
  <script src="StereoEffect.js"></script>

  <style type="text/css">
    @font-face {
      font-family: Maison Neue;
      src: url(maisonneue-medium.ttf);
      font-weight: bold;
    }

    @font-face {
      font-family: Maison Neue;
      src: url(maisonneue-mono.ttf);
      font-weight: 100;
    }

    body {
      display: flex;
      justify-content: center;
      margin-top: 50px;
    }

    #container {
      display: block;
      padding: 20px;
      border-style: solid;
      border-width: medium;
      border-color: black;
      box-shadow: 5px 7px;
      width: 75%;
      max-width: 556px;
      height: auto;

    }

    h2 {
      font-family: Maison Neue;
      font-weight: bold;
    }

    #blurb {
      display: block;
      font-family: Maison Neue;
      font-size: 14px;
      font-weight: 100;
      line-height: 1.5;

    }

    #fullScreen {
      display: block;
      margin: auto;
      margin-top: 40px;
      padding: 10px;
      width: 75%;
      background: red;
      color: white;
      border: none;
      text-decoration: none;
      font-family: Maison Neue;
      font-weight: 100;
      font-size: 16px;

    }

    #videoContainer {
      display: block;
      position: relative;
      margin: auto;
      width: 100%;
      height: 100%;

    }

    #videoContainer: -webkit-full-screen {
      width: 100%;
      height: 100%;
    }

    #videoSelect {
      display: block;
      margin: auto;
      margin-top: 30px;
      width: 75%;
    }

    #noteBar {
      display: block;
      padding: 5px;
      opacity: .75;
      position: absolute;
      background: white;
      width: auto;
      height: auto;
      max-width: 25%;
      max-height: 20%;
      top: 80px;
      right: 40px;
    }

    #textDisplay {
      display: block;
      font-family: Maison Neue;
      font-style: 10px;
      word-wrap: break-word;
    }

    #infoCard {
      display: block;
      position: absolute;
      background-color: white;
      top: 200px;
      right: 200px;
    }

    #videoContainer {
      width: auto;
      height: auto;
    }

  </style>

</head>

<body>


  <div id="container" style="margin: auto">
    <h2>Overlaying Realities</h2>
    <p id="blurb">
      This is the work-in-progress web app for Overlaying Realities.
      </br>
      </br>
      If you are using an iPhone, you are shit out of luck for now, unfortunately. If you are on Android, this app should work fine on a variety of OS verions.

      </br>
      </br>
      I have created an immersive experience to help the residents of Providence understand how climate change will affect their lives on an individual level. Using both AR and Physical computing I will be mapping the effects of Urban Heating from future climates
      onto your daily routines and behaviors. Through this mapping, I hope to show you just how different your life will be under the hot sun of a future Providence.
    </p>


    <select id="videoSelect">
      <option id="preload">Select Camera Source</option>
    </select>

    <button id="fullScreen">Start App</button>
  </div>


  <!-- <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script> -->
  <script src="webapp.js" type="text/javascript"></script>
  <script>
  </script>
  <script>
    // DOM Elements

    var fullScreen = document.getElementById('fullScreen');
    var contain = document.getElementById('container');
    var noteBar = document.createElement('div');
    noteBar.id = 'noteBar';
    var display = document.createElement('p');
    display.id = 'textDisplay';
    var video = document.createElement('video');
    video.style.display = 'none';
    video.style.width = '100%';
    video.style.height = '100%';
    video.setAttribute('autoplay', '');
    video.setAttribute('muted', '');
    video.setAttribute('playsinline', '');
    var videoSelect = document.querySelector('select');
    var videoContainer = document.createElement('div');
    // videoContainer.style.position = 'relative';
    videoContainer.id = 'videoContainer';

    //Array for location data. Includes latitude, longitude, and the name of the location

    var locationData = [
      [41.823221, -71.405951], // Latitude, Longitude, eventually Location Name
      [41.823509, -71.406211],
      [41.823177, -71.405777],
    ]

    //Info object stores the lat longitude and name of the area specified

    var infoCard = function(lat, lon, name) {
      this.lat = lat;
      this.lon = lon;
      this.name = name;
    }

    // Some code to detect current location

    function getLocation() {

      if (navigator.geolocation) {
        // console.log('location available');
        var geoLoc = navigator.geolocation.watchPosition(showPosition, showError, options);
      } else {
        console.log('location not available');
      }
    }

    function showPosition(position) {
      var crds = position.coords
      console.log(crds);
      display.innerHTML = 'Latitude: ' +
        crds.latitude.toFixed(6) + "<br>Longitude: " + crds.longitude.toFixed(6);
      checkLocation(crds);
    }

    function showError(err) {

      console.log('There is an error');
    }

    var options = {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 30000
    }

    //Some code to cycle through the location data, if current location matches a target then a notification is created.

    function checkLocation(crds) {
      for (var i = 0; i < locationData.length; i++) {
        if (crds.latitude.toFixed(6) == locationData[i][0] && crds.longitude.toFixed(6) == locationData[i][1]) {
          createNote(crds.latitude, crds.longitude);
        } else {
          console.log('no target location hit...');
        }
      }
    }

    //Some code to create a notification

    function createNote(latitude, longitude) {
      var info = new infoCard(latitude, longitude, "Target Location");
      var card = document.createElement('div');
      card.innerHTML = "Latitude: " + info.lat + "<br>Longitude: " + info.lon + "<br>Name: " + info.name;
      card.id = "infoCard";
      videoContainer.appendChild(card);
      // $('infoCard').hide().delay(250).fadeIn(500);

    }

    // Some code to check if the current device can access user media

    function hasGetUserMedia() {
      return !!(navigator.mediaDevices &&
        navigator.mediaDevices.getUserMedia);
    }

    if (hasGetUserMedia()) {
      console.log('good to go!');

    } else {

      alert('getUserMedia aint available');
    }

    // Some code to cycle through available devices and add them to the select menu

    function gotDevices(devices) {

      devices.forEach(function(devices) {
        if (devices.kind == 'videoinput') {
          var option = document.createElement('option');
          option.value = devices.deviceId;
          option.id = devices.label;
          option.text = devices.label;
          videoSelect.appendChild(option);
        }
      })
    }

    // Enumerate the available cameras on the device

    navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(function(err) {
      console.log(err.name + ": " + err.message);
    });

    // Some code to source the video stream to the video element

    function gotStream(stream) {
      window.stream = stream;
      video.srcObject = stream;
      startTHREE();
      return navigator.mediaDevices.enumerateDevices();
    }

    // Some code to launch the app and have the media stream access the selected source

    function launchApp() {

      if (window.stream) {
        window.stream.getTracks().forEach(function(tracks) {
          tracks.stop();
        });
      }

      var videoSource = videoSelect.value;

      var constraints = {
        audio: false,
        video: {
          deviceId: videoSource,
          width: 1920,
          height: 1080
        }
      }

      navigator.mediaDevices.getUserMedia(constraints).
      then(gotStream).then(gotDevices).catch(function(error) {
        console.log('navigator.getUserMedia error: ', error);
      })
    }

    // Some code to make the app relaunch after changing the source.

    videoSelect.addEventListener('change', function() {
      console.log('Launching App');
      launchApp();
    });


    //ALL THE THREEJS BULLSHIT VARIABLES
    //These have to be global I guess?
    var camera, renderer, scene, effect;
    var videoTexture;
    var canvas;

    //This function initiates the elements needed to build a Three.js scene
    function startTHREE() {

      //Code for Three.js renderer

      renderer = new THREE.WebGLRenderer();
      videoContainer.appendChild(renderer.domElement);

      effect = new THREE.StereoEffect(renderer);
      effect.setSize(container.clientWidth + 100, container.clientHeight);


      // renderer.setClearColorHex(0x000000, 0); Ignore this, I haven't really figured out what it does.
      // renderer.clear();

      //Code for Three.js camera
      var aspect = container.clientWidth / container.clientHeight; //This is basically saying that our Three.js canvas takes up the entire div space
      camera = new THREE.PerspectiveCamera(35, aspect, 1, 3000);
      camera.position.z = 750;

      scene = new THREE.Scene();



      //Code for the Three.js object (In this case it is a plane)
      var geometry = new THREE.PlaneGeometry(200, 200); //Setting the plane size to the video aspect ratio keeps things from getting warped


      //We set the video as a texture, and map it to the plane
      videoTexture = new THREE.Texture(video);
      videoTexture.minFilter = THREE.LinearFilter;
      var material = new THREE.MeshLambertMaterial({
        map: videoTexture
      });
      var plane = new THREE.Mesh(geometry, material);
      scene.add(plane);


      // -- LIGHTs
      //Apparently you need light to make the whole thing work? Idk
      var light = new THREE.DirectionalLight(0xffffff, 0.6); // color, intens.
      light.position.set(0, 0, 1); // SW directional light
      var light2 = new THREE.PointLight(0xffffff, 0.6); // color, intens.
      light2.position.set(200, 200, 300); // NE point light
      var light3 = new THREE.DirectionalLight(0xffffff, 0.5); // color, intens.
      light3.position.set(0, 0, 1); // frontal light
      scene.add(light);
      scene.add(light2);
      scene.add(light3); // add them all



      //All I'm doing here is just saying that every time I click the canvas it goes fullscreen


      // canvas.onclick = function() {
      //   canvas.webkitRequestFullScreen();
      // }

      animate();

    }

    //This basically updates the canvas continously with the video.
    function animate() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        videoTexture.needsUpdate = true;
      }

      effect.render(scene, camera);
      requestAnimationFrame(animate);
    }



    // Some code to append the video to the main container and to make the element fullscreen

    fullScreen.addEventListener('click', function() {

      // videoContainer.appendChild(video);
      // videoContainer.appendChild(noteBar);
      noteBar.appendChild(display);
      contain.insertBefore(videoContainer, fullScreen);
      // videoContainer.webkitRequestFullScreen();
      canvas = document.querySelector('canvas');
      canvas.webkitRequestFullScreen();
      // getLocation();
      // noteBar.addEventListener('click', getLocation)

    });



  </script>

</body>



</html>
